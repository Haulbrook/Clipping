/**
 * BRANCHES-V1 REMEDIATION FIXES
 * Generated by Matrix Pipeline - Chaos-Tester ‚Üí Bot-Steroids Remediation
 * 
 * INSTRUCTIONS: Add this script to your index.html before </body>
 * OR integrate these fixes into your existing js/main.js
 */

(function() {
  'use strict';

  // ============================================================
  // FIX #1: DEMO MODE - Tools work without configuration
  // ============================================================
  
  const DEMO_TOOL_URLS = {
    inventory: 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit?usp=sharing',
    grading: 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit?usp=sharing',
    scheduler: 'https://drlschedule.netlify.app/',
    tools: 'https://haulbrook.github.io/HandToolTracker/',
    chess: null,
    workorder: null,
    logistics: null,
    progress: null
  };

  const DEMO_MODE_MESSAGE = `
    <div style="padding: 40px; text-align: center; font-family: system-ui, sans-serif;">
      <h2 style="color: #666; margin-bottom: 16px;">üîß Tool Not Configured</h2>
      <p style="color: #888; margin-bottom: 24px;">
        This tool requires configuration. Go to Settings (‚öôÔ∏è) to add your Google Apps Script URL.
      </p>
      <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; text-align: left; max-width: 400px; margin: 0 auto;">
        <strong>Quick Setup:</strong>
        <ol style="margin: 12px 0; padding-left: 20px; color: #666;">
          <li>Click the Settings icon (‚öôÔ∏è) in the sidebar</li>
          <li>Enter your Google Apps Script URLs</li>
          <li>Click Save Settings</li>
          <li>Refresh and try again</li>
        </ol>
      </div>
      <p style="margin-top: 24px; font-size: 14px; color: #aaa;">
        Need help? See <a href="https://github.com/Haulbrook/Branches-V1/blob/main/DEPLOYMENT.md" target="_blank">DEPLOYMENT.md</a>
      </p>
    </div>
  `;

  // Override tool loading to show helpful message when URL is empty
  function patchToolLoader() {
    const originalOpenTool = window.openTool;
    
    window.openTool = function(toolName) {
      const settings = JSON.parse(localStorage.getItem('dashboardSettings') || '{}');
      const toolUrls = settings.toolUrls || {};
      
      const urlMap = {
        'inventory': toolUrls.inventory,
        'grading': toolUrls.grading,
        'scheduler': toolUrls.scheduler,
        'tools': toolUrls.tools,
        'chess': toolUrls.chess,
        'workorder': toolUrls.workorder,
        'logistics': toolUrls.logistics,
        'progress': toolUrls.progress
      };
      
      const url = urlMap[toolName];
      
      if (!url || url.trim() === '') {
        // Show helpful message instead of infinite loading
        const toolPanel = document.querySelector('.tool-panel-content') || 
                         document.querySelector('#tool-content') ||
                         document.querySelector('[data-tool-content]');
        
        if (toolPanel) {
          toolPanel.innerHTML = DEMO_MODE_MESSAGE;
        }
        return;
      }
      
      // Call original if URL exists
      if (typeof originalOpenTool === 'function') {
        originalOpenTool(toolName);
      }
    };
  }

  // ============================================================
  // FIX #2: HIDE API KEYS FROM CASUAL VIEW
  // ============================================================
  
  function secureApiKeyInputs() {
    const apiKeyInputs = document.querySelectorAll('input[type="text"]');
    
    apiKeyInputs.forEach(input => {
      const label = input.previousElementSibling?.textContent || '';
      if (label.toLowerCase().includes('api key') || 
          input.placeholder?.toLowerCase().includes('api key') ||
          input.id?.toLowerCase().includes('apikey')) {
        
        // Convert to password field
        input.type = 'password';
        input.autocomplete = 'off';
        
        // Add show/hide toggle
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'position: relative; display: flex; align-items: center;';
        
        const toggle = document.createElement('button');
        toggle.type = 'button';
        toggle.textContent = 'üëÅÔ∏è';
        toggle.style.cssText = `
          position: absolute;
          right: 8px;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 16px;
          opacity: 0.6;
        `;
        toggle.title = 'Show/Hide API Key';
        
        toggle.addEventListener('click', () => {
          input.type = input.type === 'password' ? 'text' : 'password';
          toggle.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        });
        
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);
        wrapper.appendChild(toggle);
      }
    });
  }

  // ============================================================
  // FIX #3: REPLACE FAKE STATS WITH HONEST PLACEHOLDER
  // ============================================================
  
  function fixHardcodedStats() {
    const statsSelectors = [
      '.stat-value',
      '.dashboard-stat',
      '[data-stat]'
    ];
    
    const statsContainer = document.querySelector('.stats-grid, .stats-container, .dashboard-stats');
    
    if (statsContainer) {
      const statCards = statsContainer.querySelectorAll('.stat-card, .stat-item, > div');
      
      statCards.forEach(card => {
        const valueEl = card.querySelector('.stat-value, .value, h2, .number');
        if (valueEl) {
          const currentValue = valueEl.textContent.trim();
          // Check if it's a hardcoded demo value
          if (['1,234', '23', '12', '98%'].includes(currentValue)) {
            valueEl.textContent = '‚Äî';
            valueEl.title = 'Connect data source in Settings';
            valueEl.style.opacity = '0.5';
          }
        }
      });
    }
  }

  // ============================================================
  // FIX #4: LOADING STATE TIMEOUT
  // ============================================================
  
  function fixLoadingStates() {
    const LOADING_TIMEOUT = 10000; // 10 seconds
    
    // Find all loading indicators
    const loadingElements = document.querySelectorAll(
      '.loading, [data-loading], .spinner, .loading-indicator'
    );
    
    loadingElements.forEach(el => {
      setTimeout(() => {
        if (el.style.display !== 'none' && el.parentNode) {
          el.innerHTML = `
            <div style="color: #999; font-size: 14px; padding: 20px; text-align: center;">
              <p>Unable to load data</p>
              <button onclick="location.reload()" style="
                margin-top: 12px;
                padding: 8px 16px;
                background: #4a90d9;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              ">Retry</button>
            </div>
          `;
        }
      }, LOADING_TIMEOUT);
    });
    
    // Fix "Recent Activity" specifically
    const recentActivity = document.querySelector('.recent-activity, #recent-activity');
    if (recentActivity) {
      const loadingText = recentActivity.querySelector('.loading, [class*="loading"]');
      if (loadingText && loadingText.textContent.includes('Loading')) {
        setTimeout(() => {
          loadingText.innerHTML = `
            <p style="color: #888; font-style: italic;">
              No recent activity. Activity will appear here as you use the tools.
            </p>
          `;
        }, 3000);
      }
    }
  }

  // ============================================================
  // FIX #5: CHAT FALLBACK MESSAGE
  // ============================================================
  
  function fixChatInterface() {
    const chatInput = document.querySelector(
      '.chat-input, #chat-input, [data-chat-input], textarea[placeholder*="Enter"]'
    );
    
    if (chatInput) {
      const originalSubmit = chatInput.form?.onsubmit || chatInput.onkeydown;
      
      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          const settings = JSON.parse(localStorage.getItem('dashboardSettings') || '{}');
          const hasApiKey = settings.claudeApiKey || settings.openaiApiKey;
          
          if (!hasApiKey) {
            e.preventDefault();
            
            // Show friendly message
            const chatContainer = document.querySelector(
              '.chat-messages, #chat-messages, .messages-container'
            );
            
            if (chatContainer) {
              const message = document.createElement('div');
              message.className = 'chat-message assistant-message';
              message.innerHTML = `
                <div style="background: #fff3cd; padding: 16px; border-radius: 8px; margin: 12px 0;">
                  <strong>‚ö†Ô∏è AI Not Configured</strong>
                  <p style="margin: 8px 0 0 0; color: #856404;">
                    To use the AI assistant, add your API key in Settings (‚öôÔ∏è).
                    <br><br>
                    Get a Claude API key at: 
                    <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>
                  </p>
                </div>
              `;
              chatContainer.appendChild(message);
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            chatInput.value = '';
          }
        }
      });
    }
  }

  // ============================================================
  // FIX #6: NAVIGATION HANDLERS
  // ============================================================
  
  function fixNavigationHandlers() {
    // Analytics link
    const analyticsLink = document.querySelector('[href*="analytics"], [data-nav="analytics"]');
    if (analyticsLink && !analyticsLink.getAttribute('data-fixed')) {
      analyticsLink.setAttribute('data-fixed', 'true');
      analyticsLink.addEventListener('click', (e) => {
        e.preventDefault();
        alert('Analytics dashboard coming soon! This feature is under development.');
      });
    }
    
    // User avatar
    const userAvatar = document.querySelector('.user-avatar, [data-user], .avatar-btn');
    if (userAvatar && !userAvatar.getAttribute('data-fixed')) {
      userAvatar.setAttribute('data-fixed', 'true');
      userAvatar.addEventListener('click', (e) => {
        e.preventDefault();
        // Toggle a simple dropdown or show message
        const existing = document.querySelector('.user-dropdown-temp');
        if (existing) {
          existing.remove();
          return;
        }
        
        const dropdown = document.createElement('div');
        dropdown.className = 'user-dropdown-temp';
        dropdown.style.cssText = `
          position: absolute;
          top: 100%;
          right: 0;
          background: white;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          min-width: 150px;
        `;
        dropdown.innerHTML = `
          <div style="padding: 8px; cursor: pointer;" onclick="document.querySelector('.settings-modal, #settings-modal')?.classList.add('show')">
            ‚öôÔ∏è Settings
          </div>
          <div style="padding: 8px; color: #999;">
            üë§ Profile (coming soon)
          </div>
        `;
        
        userAvatar.style.position = 'relative';
        userAvatar.appendChild(dropdown);
        
        // Close on outside click
        setTimeout(() => {
          document.addEventListener('click', function closeDropdown(e) {
            if (!userAvatar.contains(e.target)) {
              dropdown.remove();
              document.removeEventListener('click', closeDropdown);
            }
          });
        }, 100);
      });
    }
    
    // Command palette (‚åòK)
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        
        const searchInput = document.querySelector(
          '.search-input, #search, [data-search], input[placeholder*="Search"]'
        );
        
        if (searchInput) {
          searchInput.focus();
          searchInput.select();
        } else {
          // Create a quick command palette
          let palette = document.querySelector('.cmd-palette-temp');
          if (palette) {
            palette.remove();
            return;
          }
          
          palette = document.createElement('div');
          palette.className = 'cmd-palette-temp';
          palette.style.cssText = `
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 10000;
            min-width: 400px;
          `;
          palette.innerHTML = `
            <input type="text" placeholder="Search tools or type a command..." style="
              width: 100%;
              padding: 12px;
              border: 1px solid #ddd;
              border-radius: 8px;
              font-size: 16px;
              outline: none;
            " autofocus>
            <div style="margin-top: 12px; color: #666; font-size: 14px;">
              <div style="padding: 8px; cursor: pointer;" onclick="window.openTool?.('inventory')">üå± Inventory</div>
              <div style="padding: 8px; cursor: pointer;" onclick="window.openTool?.('scheduler')">üìÖ Scheduler</div>
              <div style="padding: 8px; cursor: pointer;" onclick="window.openTool?.('tools')">üîß Tool Checkout</div>
            </div>
          `;
          document.body.appendChild(palette);
          palette.querySelector('input').focus();
          
          // Close on escape or outside click
          const closeHandler = (e) => {
            if (e.key === 'Escape' || (e.type === 'click' && !palette.contains(e.target))) {
              palette.remove();
              document.removeEventListener('keydown', closeHandler);
              document.removeEventListener('click', closeHandler);
            }
          };
          document.addEventListener('keydown', closeHandler);
          setTimeout(() => document.addEventListener('click', closeHandler), 100);
        }
      }
    });
  }

  // ============================================================
  // FIX #7: APPLE OVERSEER HELPFUL STATE
  // ============================================================
  
  function fixAppleOverseer() {
    const overseerPanel = document.querySelector('.apple-overseer, #apple-overseer, [data-overseer]');
    
    if (overseerPanel) {
      const emptyStates = overseerPanel.querySelectorAll('*');
      emptyStates.forEach(el => {
        if (el.textContent === 'No active operations' ||
            el.textContent === 'No alerts' ||
            el.textContent === 'No recommendations') {
          el.style.color = '#999';
          el.style.fontStyle = 'italic';
        }
      });
      
      // Add helpful tooltip
      const title = overseerPanel.querySelector('h3, h4, .title');
      if (title) {
        title.title = 'Apple Overseer monitors your operations and provides AI-powered insights once tools are configured.';
      }
    }
  }

  // ============================================================
  // INITIALIZE ALL FIXES
  // ============================================================
  
  function initFixes() {
    console.log('[Branches-V1 Fixes] Initializing remediation patches...');
    
    // Wait for DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', applyFixes);
    } else {
      applyFixes();
    }
  }
  
  function applyFixes() {
    try {
      patchToolLoader();
      console.log('[Fix] Tool loader patched');
    } catch (e) {
      console.warn('[Fix] Tool loader patch failed:', e);
    }
    
    try {
      secureApiKeyInputs();
      console.log('[Fix] API key inputs secured');
    } catch (e) {
      console.warn('[Fix] API key security failed:', e);
    }
    
    try {
      fixHardcodedStats();
      console.log('[Fix] Hardcoded stats replaced');
    } catch (e) {
      console.warn('[Fix] Stats fix failed:', e);
    }
    
    try {
      fixLoadingStates();
      console.log('[Fix] Loading states patched');
    } catch (e) {
      console.warn('[Fix] Loading states fix failed:', e);
    }
    
    try {
      fixChatInterface();
      console.log('[Fix] Chat interface patched');
    } catch (e) {
      console.warn('[Fix] Chat fix failed:', e);
    }
    
    try {
      fixNavigationHandlers();
      console.log('[Fix] Navigation handlers added');
    } catch (e) {
      console.warn('[Fix] Navigation fix failed:', e);
    }
    
    try {
      fixAppleOverseer();
      console.log('[Fix] Apple Overseer enhanced');
    } catch (e) {
      console.warn('[Fix] Overseer fix failed:', e);
    }
    
    console.log('[Branches-V1 Fixes] All patches applied ‚úÖ');
  }
  
  // Run
  initFixes();
  
})();
